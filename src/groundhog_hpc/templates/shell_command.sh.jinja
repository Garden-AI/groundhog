set -euo pipefail

if command -v uv &> /dev/null; then
    UV_BIN=$(command -v uv)
else
    if command -v python &> /dev/null; then
        PYTHON=python
    elif command -v python3 &> /dev/null; then
        PYTHON=python3
    else
        echo "Error: No Python interpreter found" >&2
        exit 1
    fi
    $PYTHON -m pip install uv &> /dev/null || true
    UV_BIN=$($PYTHON -c 'import uv; print(uv.find_uv_bin())' 2>/dev/null || command -v uv 2>/dev/null || echo "uv")
fi

cat > {{ user_script_name }}.py << 'USER_SCRIPT_EOF'
{{ user_script_contents | escape_braces }}
USER_SCRIPT_EOF

cat > {{ runner_name }}.py << 'RUNNER_EOF'
{{ runner_contents | escape_braces }}
RUNNER_EOF

cat > {{ script_name }}.in << 'PAYLOAD_EOF'
{{ payload }}
PAYLOAD_EOF

# use scratch/temp directory for uv cache to avoid filesystem locking issues
# GROUNDHOG_CACHE_DIR var allows users to override if needed
{% raw %}GROUNDHOG_CACHE_BASE="${{GROUNDHOG_CACHE_DIR:-${{SCRATCH:-${{TMPDIR:-/tmp}}}}}}"
GROUNDHOG_USER="${{USER:-$(id -un)}}"

if [ -z "${{UV_CACHE_DIR:-}}" ]; then
    export UV_CACHE_DIR="${{GROUNDHOG_CACHE_BASE}}/uv-cache-${{GROUNDHOG_USER}}"
fi

if [ -z "${{UV_PYTHON_INSTALL_DIR:-}}" ]; then
    export UV_PYTHON_INSTALL_DIR="${{GROUNDHOG_CACHE_BASE}}/uv-python-${{GROUNDHOG_USER}}"
fi{% endraw %}

mkdir -p "$UV_CACHE_DIR" "$UV_PYTHON_INSTALL_DIR"
"$UV_BIN" run --managed-python --with {{ version_spec }} \
  {{ runner_name }}.py

echo "__GROUNDHOG_RESULT__"
cat {{ script_name }}.out
